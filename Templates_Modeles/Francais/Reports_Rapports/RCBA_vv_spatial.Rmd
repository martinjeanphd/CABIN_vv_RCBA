---
date: '2017-09-27'
output:
  html_notebook:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_float: yes
  html_document:
    df_print: paged
    toc: yes
  word_document:
    toc: yes
version: '1.1'
---

| ![](../../../Configuration/gc_fr.png)  |  ![](../../../Configuration/rcba_logo.png) |
|:------------------------------------|--------------------------------------:|                            


# VÉRIFICATION ET VALIDATION RCBA - DONNÉES SPATIALES

*Environnement et changement climatique Canada*

*Analyse réalisée le `r Sys.time()`*

***

```{r setup, include=FALSE}
## Modules requis et fonctions personnalisées
source("../../../Required_packages.R")
source("../../../Required_functions.R")


## Préférences du projet
source("../../../Configuration/project_settings.R")

```


Ce document est un carnet de note écrit en [Markdown R](http://rmarkdown.rstudio.com). Lorsque vous éxécuter le code intégré au carnet, les résulats apparaitront sous le code correspondant.

Ce rapport présente les résultats de la vérification et la validation des données géographiques pour le projet **`r paste(analysisTitle)`**.

Dans cette analyse, les coordonnées géographiques sont vérifiées pour répondre à la question suivante :
  
  + Les coordonnées géographiques du jeu de données correspondent-elles bien à la localisation des sites visités ?
  
Ce document est un carnet de notes [R Markdown](http://rmarkdown.rstudio.com). Pour obtenir les résultats de la vérification et la validation des données, exécutez les commandes contenues dans ce carnet de notes. Pour ce faire, positionnez votre curseur à l'intérieur d'une boîte de commandes et cliquez sur la flèche verte à la droite de celle-ci nommée *Run Current Chunk* ou appuyez sur les touches *Ctrl+Maj+Entrée* (*Cmd-Maj+Entrée* sur *macOS*) de votre clavier. Répétez pour chaque boîte de commandes. À mesure que les commandes contenues dans ce carnet seront exécutées, les résultats apparaîtront sous chacune des commandes correspondantes dans la présente fenêtre. Une fois toutes les commandes exécutées, cliquez sur le bouton *Preview* en haut à gauche de la présente fenêtre ou appuyer sur les touches *Ctrl+Maj+K* (*Cmd-Maj+K* sur *macOS*). Une nouvelle fenêtre apparaîtra et contiendra le rapport de ces résultats de la vérification et la validation des données spatiales RCBA.


## Prérequis

Ce carnet suppose que vous avez importé vos données dans *R* en utilisant le carnet d'importation de données (AED_Importation.Rmd).

Le fichier contenant les donneés spatiales de ce projet est **`r if(is.data.frame(dataset.SPA)) "présent" else "absent. Veuillez ouvrir et exécuter le carnet 'RCBA_vv_importation.Rmd' avant d'exécuter le présent carnet"`**.

## Statistiques descriptives

Le fichier de données contient `r {nrow(dataset.SPA)} ` visites (lignes) et `r {ncol(dataset.SPA)} ` variables (colonnes).

Le tableau suivant présente une partie des données du fichier.

<!-- `r head(dataset.SPA) ` -->

**Liste des visites (ID provenant de la base de données RCBA) :**  


`r dataset.SPA$SampleId `

> ![ACTION:](../../../Configuration/action.png)
> *Vérifiez les données et assurez-vous que cela réflète bien la réalité. Comparez la liste ci-haut avec le tableau suivant qui présente les visites présentes dans l'un ou l'autre des fichiers de données pour vous assurez que tout est adéquat.

`r datatable(dataset.NAM, filter = "top", rownames=F, options = list(scrollX = TRUE ))`

**Liste des variables :**  

`r colnames(dataset.SPA) `


### Statistiques générales

Le tableau suivant présente les principaux paramètres généraux par variable. Lorsque le résultat obtenu à la ligne *BinaryData* du tableau est *TRUE*, cela indique que la variable présente des données binaires. Cependant, ce résultat peut également n'être obtenu que parce que la variable ne présente qu'une à deux données au maximum. La ligne *Na.values* indique le nombre de valeurs manquantes que présente chaque variable.


**Tableau des paramètres généraux par variable**  

```{r, echo=FALSE, warning=FALSE}

#Tableau des descripteurs généraux

{summary.SPA <- as.data.frame(t(do.call(cbind, lapply(dataset.SPA, summary))))
summary.SPA$Std.deviation <- apply(dataset.SPA, 2, sd, na.rm = T)
summary.SPA$Length <- colSums(!is.na(dataset.SPA))
summary.SPA$BinaryData <- sapply(dataset.SPA,function(x)length(unique(na.omit(x)))<=2)
summary.SPA$NA.values <- colSums(is.na(dataset.SPA))
summary.SPA$`NA's` <- NULL
summary.SPA <- as.data.frame(t(summary.SPA))
summary.SPA$GPSDatum <- NULL
}
datatable(summary.SPA[,-3], filter = "top", rownames=F, options = list(scrollX = TRUE ))

```


> ![ACTION:](../../../Configuration/action.png)
> *Vérifiez les données et assurez-vous que cela réflète bien la réalité. Examinez les statistiques de base et identifiez, le cas échéant, des anomalies au niveaux des statistiques de base.


## Présence de données aberrantes

### Localisation des sites

La carte interactive suivante illustre la position des sites des visites en fonction des coordonnées géographiques contenues dans le fichier de données.

```{r, echo=FALSE, include=TRUE, fig.width = 8.5, fig.height = 5.5}
#Cartographie de la distribution des coordonnées géographiques des sites

dataset.SPA2 <- dataset.SPA
dataset.NAM2 <- dataset.NAM
dataset.SPA2 <- left_join(dataset.SPA2, dataset.NAM2[, c("SampleId", "Site", "SampleDate", "SampleNumber")], by = "SampleId")
dataset.SPA2$Site_Date_Number <- paste(dataset.SPA2$Site, "_", dataset.SPA2$SampleDate, "_", dataset.SPA2$SampleNumber, sep = "")
dates <- as.Date(dataset.SPA2$SampleDate, "%Y-%m-%d")
dataset.SPA2$Year <- strftime(parse_date_time(as.character(dates), "%Y-%m-%d"), "%y")
dataset.SPA2$Site_Year <- paste(dataset.SPA2$Site, "_", dataset.SPA2$Year)

cabinPoints <- SpatialPointsDataFrame(coords = dataset.SPA[which(!is.na(dataset.SPA[, 1]) & !is.na(dataset.SPA[,2])),1:2], data = dataset.SPA[which(!is.na(dataset.SPA[, 1]) & !is.na(dataset.SPA[,2])),])

leaflet(data = dataset.SPA2[, c("Longitude", "Latitude")]) %>% addProviderTiles(providers$Esri.WorldTopoMap) %>%
  addCircleMarkers(~Longitude, ~Latitude, popup = paste("Site_Year:", dataset.SPA2$Site_Year), label = dataset.SPA2$Site_Year, color = getColor2(dataset.SPA2), stroke = F, fillOpacity = 0.5, clusterOptions = markerClusterOptions()) %>% addLegend(
  position = 'bottomright',
  colors = c("green", "yellow", "darkorange", "red", "pink", "blue", "darkgreen", "cyan", "deeppink", "lightblue", "lightseagreen", "darkviolet", "darkred", "cadetblue", "black", "gray", "white", "brown"),
  labels = c("Pre-2006", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "Other"),
  opacity = 1,
  title = 'Légende')

rm(dataset.NAM2)
```


### Dispersion des valeurs observées

Les diagrammes de dispersion suivants présentent la valeur des données de variables continues observées dans le fichier de données dans l'ordre à laquelle elles apparaissent dans ce fichier. Sous l'axe des X se trouve l'identifiant de la visite vis-à-vis la valeur observée correspondante, soit le nom du site d'où provient la donnée, sa date d'échantillonnage et le nombre d'échantillonnage pris pour cette donnée.

> ![ACTION:](../../../Configuration/action.png)
> *Vérifiez les données et assurez-vous que cela réflète bien la réalité. Examinez particulièrement les éléments suivants:*
>
> - *Des données semblent-elles sortir de l'ordinaire?*

```{r, echo=FALSE, warning=FALSE}
#Diagramme de dispersion de la latitude et la longitude

for(j in 1:2){
plot.ab <- ggplot(dataset.SPA2, aes(x = dataset.SPA2$Site_Date_Number, y = dataset.SPA2[,j])) +
  geom_point(aes(text=sprintf("Test", dataset.SPA2$Site_Date_Number))) +
  labs(y = colnames(dataset.SPA2[j]), x = "Visit") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.05)) +
   scale_x_discrete(breaks = "", labels = "", na.value = NA) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle(paste("Valeurs observées de", colnames(dataset.SPA2[j]), "par visite"))
plot.ab
print(plot.ab)
}

```


### Identification des données aberrantes potentielles

La première boîte à moustaches (à gauche) présentent la distribution des valeurs de variables continues observées dans le fichier de données et le diagramme de dispersion (à droite) présentent la distribution des valeurs de variables continues observées dans l'ordre à laquelle elles apparaissent dans ce fichier. Les données présentant une identification par leur identifiant sur les diagrammes représentent les données potentiellement aberrantes contenues dans le fichier de données. La méthode utilisée pour identifier les données potentiellement aberrantes est l'étendue interquantile (*Interquantile range* ou *IQR*). L'IQR se calcule de la manière suivante :

`IQR(x) = quantile(x, 3/4) - quantile(x, 1/4)`


Les valeurs potentiellement aberrantes sont définies comme des observations qui se situent au-dessous de *Q1 - 1,5 IQR* ou plus de *Q3 + 1,5 IQR*.

L'identifiant de la visite correspond au nom du site d'où provient la donnée, sa date d'échantillonnage et le nombre d'échantillonnage pris pour cette donnée.

> ![ACTION:](../../../Configuration/action.png)
> *Examinez les graphiques suivants et portez votre attention sur les points (si présents) auxquels un identifiant est associé. Posez-vous la question suivante :*
>
> - *Les données potentiellement aberrantes le sont-elles vraiment?*



```{r, echo=FALSE, warning=FALSE}
#Identification des données aberrantes potentielles

for (j in 1:2) {
  boxplot <- ggplot(data = dataset.SPA2, aes(x = "", y = dataset.SPA2[,j])) +
    geom_boxplot() +
    ylab(colnames(dataset.SPA2[j])) +
    xlab("") +
    theme(plot.title = element_text(hjust = 0.5)) +
    ggtitle(paste("Distribution des valeurs\nobservées de", colnames(dataset.SPA2[j]))) +
    geom_text(aes(label = ifelse(dataset.SPA2[,j] < quantile(dataset.SPA2[,j], probs=c(.25), na.rm = T) - 1.5*IQR(dataset.SPA2[,j], na.rm = T)|dataset.SPA2[,j] > quantile(dataset.SPA2[,j], probs=c(.75), na.rm = T) + 1.5*IQR(dataset.SPA2[,j], na.rm = T), dataset.SPA2$Site_Date_Number, "")), hjust = -0.05, size = 3)

  dotchart <- ggplot(data = dataset.SPA2, aes(y = seq(dataset.SPA2[,j]), x = dataset.SPA2[,j], na.rm = T)) +
    geom_point(na.rm = T) +
    ylab("Ordre des données") +
    xlab(colnames(dataset.SPA2[j])) +
    theme(plot.title = element_text(hjust = 0.5)) +
    ggtitle(paste("Distribution des valeurs\nobservées de", colnames(dataset.SPA2[j]))) +
    geom_text(aes(label = ifelse(dataset.SPA2[,j] < quantile(dataset.SPA2[,j], probs=c(.25), na.rm = T) - 1.5*IQR(dataset.SPA2[,j], na.rm = T)|dataset.SPA2[,j] > quantile(dataset.SPA2[,j], probs=c(.75), na.rm = T) + 1.5*IQR(dataset.SPA2[,j], na.rm = T), dataset.SPA2$Site_Date_Number, "")), hjust = -0.05, nudge_y = 2, size = 3)
        
  grid.arrange(boxplot, dotchart, ncol = 2)
}

```

La liste suivante présente les données potentiellement aberrantes contenues dans le fichier de données pour chaque variable. Lorsque l'identifiant d'une donnée y est indiqué, cela indique que cette donnée représente une donnée potentiellement aberrante contenue dans le fichier de données. Les mentions *""* indiquent les données non aberrantes et les mentions *NA* indiquent la présence de valeurs manquantes. L'identifiant de la visite correspond au nom du site d'où provient la donnée, sa date d'échantillonnage et le nombre d'échantillonnage pris pour cette donnée.

```{r, echo=FALSE}
##Identification des données aberrantes potentielles (suite)

for (j in 1:2) {
  cat(colnames(dataset.SPA2[j]), "\n")
  Active_Frame_Spatial <- data.frame(ifelse(is.na(dataset.SPA2[, j]), "", ifelse(dataset.SPA2[, j] < quantile(dataset.SPA2[, j], probs = c(.25), na.rm = T) - 1.5 * IQR(dataset.SPA2[, j], na.rm = T) | dataset.SPA2[, j] > quantile(dataset.SPA2[, j], probs = c(.75), na.rm = T) + 1.5 * IQR(dataset.SPA2[, j], na.rm = T), dataset.SPA2$Site_Date_Number, "")))
  Active_Frame_Spatial["Is NA"] <- list(ifelse(is.na(dataset.SPA2[, j]), "Yes", "No"))
  colnames(Active_Frame_Spatial) <- c("Site_Date_SampleNumber", "Is_NA")
  write.table(Active_Frame_Spatial[Active_Frame_Spatial$Site_Date_SampleNumber != "", ], row.names = FALSE, quote = FALSE, na = "NA", sep = ", ")
  cat("Nombre de données aberrantes potentielles:", length(Active_Frame_Spatial[Active_Frame_Spatial$Site_Date_SampleNumber != "", ][[1]]), "\n\n")
}

```

##Notes sur les versions
**Quoi de nouveau, mis à jour ou corrigé dans cette version**

***
![ACTION:](../../../Configuration/logo_new.png) Nouveau &nbsp;&nbsp;&nbsp;   ![ACTION:](../../../Configuration/logo_updated.png) Mise à jour &nbsp;&nbsp;&nbsp;  ![ACTION:](../../../Configuration/logo_fixed.png) Corrigé

***

**RCBA_vv_spatial.Rmd Version 1.1 — 27 septembre 2017**

Cette version présente des suggestions d'actions en rapport avec la vérification et validation des données spatiales.

![ACTION:](../../../Configuration/logo_new.png)   **Actions**.

**RCBA_vv_spatial.Rmd Version 1.0 — 18 août 2017**

Version initiale de l'outil de vérification et validation des données spatiales.

![ACTION:](../../../Configuration/logo_new.png)   **Première version**.


***

Développé par [Martin Jean](mailto:martin.jean@canada.ca) et Evelyne Paquette-Boisclair